pico-8 cartridge // http://www.pico-8.com
version 29
__lua__
-- asdf

px = 30
py = 30
ps = 2
pcharge = 0.25  -- min 0.25 to line up ui meter
php = 10
ymax = 128-17

cooldown = 0
max_cooldown = 10
paused = false
rock_counter = 0

function _init()
	bullet = {}
	rock = {}
	smoke = {}
 part = {}
end

function _update()
	if (btnp(5)) paused = not paused
	if (paused and not btnp(4)) return

 ps = 4
 if (btn(4)) ps = 2
	if (btn(0)) px -= ps
	if (btn(1)) px += ps
	if (btn(2)) py -= ps
	if (btn(3)) py += ps
 px = clamp(px,0,120)
 py = clamp(py,0,ymax-10)
	
	foreach(bullet, move_bullet)
	foreach(rock, move_rock)
	foreach(smoke, move_smoke)
	foreach(part, move_part)
	
	for b in all(bullet) do
	 for r in all(rock) do
	  -- aabb(b, r)
   if (sphere_col(b,r)) then
    b.hp-=1
    r.hp-=1
   end
   if (b.hp <= 0) kill_bullet(b)
   if (r.hp <= 0) kill_rock(r)
	 end
	end
	
	if (cooldown > 0) then
  cooldown -= 1
	elseif (btn(4)) then
		make_bullet(px, py)
		make_bullet(px+7, py)
		cooldown = max_cooldown
	end
 if (not btn(4) and pcharge<10) pcharge += .02
	
 rock_counter+=1+rnd()
	if (rock_counter>20) then
  make_rock()
  rock_counter=0
 end
end

function _draw()
	cls(1)
	foreach(rock, draw_rock)
	foreach(smoke, draw_smoke)
	foreach(part, draw_part)
	foreach(bullet, draw_bullet)
	draw_player()

 -- draw ui
 -- ui is 17 pixels tall
 -- fill black box, draw border
 rectfill(0,111,128,128,0)
 spr(4,0,111)
 spr(4,0,120,1,1,false,true)
 spr(4,120,111,1,1,true,false)
 spr(4,120,120,1,1,true,true)
 color(6)
 line(8,112,119,112)
 line(8,126,119,126)
 pset(1,119)
 pset(126,119)

 -- portrait
 rectfill(4,114,14,124,1)

 -- hud contents
 spr(5,17,114)
 print(":0000",22,114,10)
 print("h:",49,114,11)
 print("e:",49,120,12)

 -- meters
 -- block fill pattern
 fillp(0x8888)
 rectfill(56,114,56+php*4,118,11)
 color(12)
 if (pcharge>=10) color(7)
 rectfill(56,120,55+min(pcharge,10)*4,124)
 fillp()

end

-->8
-- wa

bullets = {}

function draw_player()
	spr(1, px, py)
	
	-- draw engine lights
	color(14)
	if (time()%0.4<0.2) then
		line(px+1, py+9, px+1, py+9)
		line(px+6, py+9, px+6, py+9)
		color(7)
	end
	line(px+1, py+8, px+1, py+8)
	line(px+6, py+8, px+6, py+8)
end

function draw_bullet(b)
	--pset(b.x, b.y, 11)
	line(b.x, b.y, b.x, b.y+b.h-1, 14)
	--line(b.x, b.y+4, b.x, b.y+7, 3)
end

function move_bullet(b)
	b.y -= 4
	
	for y=5,7,2 do
		make_smoke(b.x, b.y+y, 2, 4)
	end
	
	if (b.y < -4) del(bullet, b)
end

function draw_smoke(s)
	pset(s.x, s.y, s.c)
end

function draw_part(p)
 spr(p.f, p.x, p.y)
end

function move_smoke(s)
 s.x+=s.dx
 s.y+=s.dy
	s.t -= 1
	if (s.t <= 0) del(smoke, s)
end

function move_part(p)
 p.f += p.df
 p.t -= 1
 if (p.t <= 0) del(part, p)
end

function move_rock(r)
	r.y += r.dy
	if (r.y > ymax) del(rock, r)
end

function draw_rock(r)
	spr(14, r.x, r.y,2,2)
	-- map(0,0,r.x,r.y,2,2)
end

function kill_bullet(b)
 make_particle(b.x-3, b.y-3, 2, 0.34, 6)
 del(bullet, b)
end

function kill_rock(r)
 del(rock, r)
end

-->8
-- guf

function make_bullet(x,y)
	local b = {
		x=x, y=y, w=1, h=6,
  hp=1, xo=0, yo=0, r=0.5
	}
	add(bullet, b)
end

function make_rock()
 local x=rnd(128-16)
	local y=-20
	local dy=rnd(.5)+.5
	local r = {
		x=x, y=y, dy=dy, w=16, h=16,
		hp=4, xo=8, yo=8, r=8
	}
	add(rock, r)
end

function make_smoke(x,y,c,t,dx,dy)
	local s = {
	 -- coords, colour, time
		x=x, y=y, c=c, t=t,
  -- speed (optional)
  dx=(dx or 0), dy=(dy or 0)
	}
	add(smoke, s)
end

function make_particle(x,y,f,df,t)
 local p = {
  -- coords, spr, dspr, time
  x=x, y=y, f=f, df=df, t=t
 }
 add(part, p)
end
-->8
-- util functions

function aabb(a, b)
 if (not a or not b) return
 
	if (a.x<b.x+b.w and a.x+a.w>b.x) then
		if (a.y<b.y+b.h and a.y+a.h>b.y) then
			-- todo: dumb
			-- a is bullet, b is rock
   a.hp-=1
			b.hp-=1
		end
	end
end

function sphere_col(a, b)
 if (not a or not b) return
 
 local dx=a.x+a.xo-b.x-b.xo
 local dy=a.y+a.yo-b.y-b.yo
 local d=dx*dx+dy*dy
 local r2=a.r+b.r
 return d<r2*r2
end

function clamp(n, lower, upper)
 return max(min(n, upper), lower)
end
__gfx__
00000000000660000000000000020000000000000aa0000000000000000000000000000000000000000000000000000000000000000000000000000dddd00000
0000000000066000000e00000020200006066666a00a0000000000000000000000000000000000000000000000000000000000000000000000000dddddddd000
007007000066660000e7e000020002000060000000aa00000000000000000000000000000000000000000000000000000000000000000000000ddddddddddd00
00077000006c76000e777e002000002006000000000a0000000000000000000000000000000000000000000000000000000000000000000000ddd5ddddddddd0
00077000066cc66000e7e0000200020006000000aaaa000000000000000000000000000000000000000000000000000000000000000000000ddd5dddddddddd0
0070070066666666000e00000020200006000000000000000000000000000000000000000000000000000000000000000000000000000000ddd55ddddddddddd
0000000066566566000000000002000006000000000000000000000000000000000000000000000000000000000000000000000000000000ddd55ddddddddddd
000000000d5665d0000000000000000006000000000000000000000000000000000000000000000000000000000000000000000000000000dddd55dd5ddddddd
00000000070000700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005dddd555dddddddd
000000000e0000e00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005ddddddddddddddd
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000055dddddddddddddd
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000055ddddd5dddddd0
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005555dddd55dddd0
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005555ddddddddd0
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005555dddddd00
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005555ddd000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
06066666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666060
00600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600
060011111111111000aa000000aaa0aaa0aaa0aaa00000000b0b00000bbb0bbb0000000000000000000000000000000000000000000000000000000000000060
06001111111111100a00a00a00a0a0a0a0a0a0a0a00000000b0b00b00bbb0bbb0000000000000000000000000000000000000000000000000000000000000060
0600111111111110000aa00000a0a0a0a0a0a0a0a00000000bbb00000bbb0bbb0000000000000000000000000000000000000000000000000000000000000060
06001111111111100000a00a00a0a0a0a0a0a0a0a00000000b0b00b00bbb0bbb0000000000000000000000000000000000000000000000000000000000000060
06001111111111100aaaa00000aaa0aaa0aaa0aaa00000000b0b00000bbb0bbb0000000000000000000000000000000000000000000000000000000000000060
06001111111111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000060
0600111111111110000000000000000000000000000000000ccc00000ccc0ccc0000000000000000000000000000000000000000000000000000000000000060
0600111111111110000000000000000000000000000000000c0000c00ccc0ccc0000000000000000000000000000000000000000000000000000000000000060
0600111111111110000000000000000000000000000000000cc000000ccc0ccc0000000000000000000000000000000000000000000000000000000000000060
0600111111111110000000000000000000000000000000000c0000c00ccc0ccc0000000000000000000000000000000000000000000000000000000000000060
0600111111111110000000000000000000000000000000000ccc00000ccc0ccc0000000000000000000000000000000000000000000000000000000000000060
00600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600
06066666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666060
